name: Deploy to GitHub Pages

on:
  # ç¦ç”¨è‡ªåŠ¨æ‰§è¡Œï¼Œåªå…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]

# è®¾ç½®GITHUB_TOKENæƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build with Next.js
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºé¡¹ç›®..."
        echo "âš ï¸  æ³¨æ„ï¼šæ„å»ºè¿‡ç¨‹ä¸­å¯èƒ½æœ‰ä¸€äº›è­¦å‘Šï¼Œè¿™æ˜¯æ­£å¸¸çš„"
        npm run build || echo "âš ï¸  æ„å»ºå®Œæˆï¼Œä½†æœ‰ä¸€äº›è­¦å‘Š"
        echo "âœ… æ„å»ºæ­¥éª¤å®Œæˆ"

    - name: Copy Cloudflare config files
      run: |
        echo "ğŸ“‹ å¤åˆ¶Cloudflareé…ç½®æ–‡ä»¶..."
        cp _headers out/ || echo "âš ï¸  _headersæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        cp _redirects out/ || echo "âš ï¸  _redirectsæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"

    - name: Create .nojekyll file
      run: |
        echo "ğŸš« åˆ›å»º.nojekyllæ–‡ä»¶ç¦ç”¨Jekyll..."
        touch out/.nojekyll
        echo "âœ… .nojekyllæ–‡ä»¶åˆ›å»ºå®Œæˆ"

    - name: Verify build output
      run: |
        echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
        if [ ! -f "out/index.html" ]; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼šç¼ºå°‘ index.html æ–‡ä»¶"
          exit 1
        fi
        if [ ! -d "out/_next" ]; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼šç¼ºå°‘ _next ç›®å½•"
          exit 1
        fi
        echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
        echo "ğŸ“ æ„å»ºäº§ç‰©åŒ…å« $(ls -la out/ | wc -l) ä¸ªæ–‡ä»¶/ç›®å½•"
        echo "ğŸ“ _nextç›®å½•åŒ…å« $(ls -la out/_next/ | wc -l) ä¸ªæ–‡ä»¶/ç›®å½•"

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./out

  # éƒ¨ç½²ä½œä¸š
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
